<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Visualizador de Inscripciones</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/datatables.net-bs5@2.1.8/css/dataTables.bootstrap5.min.css" rel="stylesheet">

  <style>
    body { background:#0b1220; }
    .app-shell{
      max-width: 1350px;
      margin: 16px auto;
      padding: 14px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 18px;
      backdrop-filter: blur(10px);
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
    }
    .title { color:#fff; }
    .muted { color: rgba(255,255,255,.7); }

    /* Compacto */
    .table td, .table th { padding:.32rem .40rem !important; font-size:.90rem; }
    .table { --bs-table-bg: rgba(255,255,255,.04); --bs-table-color:#fff; }
    .table thead th { background: rgba(255,255,255,.10); border-bottom:1px solid rgba(255,255,255,.14); }
    .table tbody td { border-top:1px solid rgba(255,255,255,.08); }
    table.dataTable { width:100% !important; }

    /* ‚úÖ Para que NO ‚Äúdesaparezca‚Äù texto */
    #tabla { table-layout: fixed; }
    #tabla th, #tabla td { overflow: hidden; }
    /* Sede y Comisi√≥n (√Årea) con wrap, sin cortar */
    #tabla td:nth-child(3),
    #tabla td:nth-child(4) {
      white-space: normal !important;
      word-break: break-word;
    }

    .badge-soft{
      background: rgba(255,255,255,.12);
      border: 1px solid rgba(255,255,255,.18);
      color:#fff;
      font-weight:600;
    }

    .progress{ height:10px; background: rgba(255,255,255,.12); }
    .progress-bar{ transition: width .25s ease; }

    .dt-search input, .dt-length select, .form-select{
      background: rgba(255,255,255,.08) !important;
      border: 1px solid rgba(255,255,255,.18) !important;
      color:#fff !important;
    }
    .dataTables_info, .dataTables_paginate, .dataTables_length, .dataTables_filter, label, .pagination *{
      color: rgba(255,255,255,.8) !important;
    }

    .chip { display:inline-flex; align-items:center; gap:8px; }
    .dot { width:10px; height:10px; border-radius:999px; display:inline-block; }
    .dot-ok{ background:#22c55e; }
    .dot-mid{ background:#f59e0b; }
    .dot-hi{ background:#ef4444; }
    .smallish{ font-size:.92rem; }
  </style>
</head>

<body>
  <div class="app-shell">
    <div class="d-flex flex-wrap align-items-end justify-content-between gap-3 mb-3">
      <div>
        <h1 class="title h3 mb-1">Visualizador de Inscripciones</h1>
        <div class="muted small">Orden fijo: D√≠a ‚Üí Horario ‚Üí Sede ‚Üí Comisi√≥n. Sin ‚Äúmagia‚Äù que rompa el orden.</div>
      </div>
      <div class="d-flex gap-2 align-items-center">
        <button id="btnReload" class="btn btn-outline-light btn-sm">üîÑ Recargar</button>
        <a id="btnOpenCsv" class="btn btn-light btn-sm" target="_blank" rel="noopener">Abrir CSV</a>
      </div>
    </div>

    <!-- FILTROS -->
    <div class="row g-2 mb-3">
      <div class="col-12 col-md-2">
        <label class="muted small mb-1">D√≠a</label>
        <select id="filterDia" class="form-select form-select-sm">
          <option value="">Todos</option>
        </select>
      </div>
      <div class="col-12 col-md-2">
        <label class="muted small mb-1">Fecha</label>
        <select id="filterFecha" class="form-select form-select-sm">
          <option value="">Todas</option>
        </select>
      </div>
      <div class="col-12 col-md-2">
        <label class="muted small mb-1">Horario</label>
        <select id="filterHorario" class="form-select form-select-sm">
          <option value="">Todos</option>
        </select>
      </div>
      <div class="col-12 col-md-2">
        <label class="muted small mb-1">Sede</label>
        <select id="filterSede" class="form-select form-select-sm">
          <option value="">Todas</option>
        </select>
      </div>
      <div class="col-12 col-md-2">
        <label class="muted small mb-1">Comisi√≥n (√Årea)</label>
        <select id="filterArea" class="form-select form-select-sm">
          <option value="">Todas</option>
        </select>
      </div>
      <div class="col-12 col-md-2">
        <label class="muted small mb-1">Resumen</label>
        <div id="summary" class="p-2 rounded smallish"
             style="background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.12); color:#fff;">
          ‚Äî
        </div>
      </div>
    </div>

    <div class="table-responsive">
      <table id="tabla" class="table table-hover table-striped align-middle w-100">
        <thead>
          <tr>
            <th style="width:90px;">D√≠a</th>
            <th style="width:80px;">Fecha</th>
            <th style="width:320px;">Sede</th>
            <th style="width:360px;">Comisi√≥n</th>
            <th style="width:70px;" class="text-end">Cupo</th>
            <th style="width:80px;" class="text-end"># Inscr.</th>
            <th style="width:70px;">%</th>
            <th style="width:180px;">Ocupaci√≥n</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <div class="muted small mt-3">
      Si ‚ÄúComisi√≥n‚Äù trae comas (ej: ‚ÄúCiencias Naturales, Matem√°tica‚Ä¶‚Äù), se muestra bien porque el CSV se parsea correctamente.
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.7.1/dist/jquery.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/datatables.net@2.1.8/js/dataTables.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/datatables.net-bs5@2.1.8/js/dataTables.bootstrap5.min.js"></script>

  <script>
    const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ2avA92LvHh37HuCigjLogbT2hhoLprim9OJu7tI9Do2jU6u1hnEsrMov5UKpJHqNcx9fNESB2W3d4/pub?output=csv";

    // columnas del CSV
    const colAliases = {
      dia: ["Dia","D√≠a","dia","d√≠a"],
      fecha: ["Fecha","fecha"],
      horario: ["Horario","horario"],
      sede: ["Sede","sede"],
      area: ["√Årea","Area","area","√°rea"],
      cupo: ["Cupo","cupo"],
      inscritos: ["# Inscr.","#Inscr.","Inscr.","Inscritos","inscritos","# Insc","# Insc."],
      porcentaje: ["%","Porcentaje","% ","porcentaje"]
    };

    function pick(row, key){
      for (const n of (colAliases[key]||[])) if (row[n] !== undefined) return row[n];
      return "";
    }

    function toNumber(x){
      const s = String(x ?? "").trim().replace(/\./g,"").replace(",",".").replace("%","");
      const n = Number(s);
      return Number.isFinite(n) ? n : NaN;
    }

    function pctFrom(row){
      const pctRaw = pick(row,"porcentaje");
      const pct = toNumber(pctRaw);
      if (Number.isFinite(pct)) return pct;

      const cupo = toNumber(pick(row,"cupo"));
      const ins  = toNumber(pick(row,"inscritos"));
      if (Number.isFinite(cupo) && cupo > 0 && Number.isFinite(ins)) return (ins/cupo)*100;
      return NaN;
    }

    function occClass(pct){
      if (!Number.isFinite(pct)) return {label:"‚Äî", dot:"", bar:"bg-secondary"};
      if (pct>=100) return {label:"Lleno", dot:"dot-hi", bar:"bg-danger"};
      if (pct>=85)  return {label:"Alta",  dot:"dot-hi", bar:"bg-danger"};
      if (pct>=50)  return {label:"Media", dot:"dot-mid", bar:"bg-warning"};
      return {label:"Baja", dot:"dot-ok", bar:"bg-success"};
    }

    function escapeHtml(s){
      return String(s ?? "")
        .replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;")
        .replaceAll('"',"&quot;").replaceAll("'","&#039;");
    }

    function uniqueValues(rows, key){
      const set = new Set();
      for (const r of rows){
        const v = String(pick(r,key) ?? "").trim();
        if (v) set.add(v);
      }
      return Array.from(set).sort((a,b)=>a.localeCompare(b,"es"));
    }

    // ‚úÖ Orden: D√≠a -> Horario -> Sede -> Comisi√≥n
    // Para fecha dd/mm (sin a√±o) armamos un key mmdd
    function fechaKey(fechaStr){
      const s = String(fechaStr || "").trim();
      const m = s.match(/^(\d{1,2})\/(\d{1,2})/);
      if (!m) return 999999;
      const dd = String(m[1]).padStart(2,"0");
      const mm = String(m[2]).padStart(2,"0");
      return Number(mm + dd);
    }

    function horarioKey(h){
      const s = String(h || "").trim();
      // busca primer n√∫mero como hora inicio (ej "14 a 17", "14-17", "14:00 a 17:00")
      const m = s.match(/(\d{1,2})(?::\d{2})?/);
      if (!m) return 999;
      return Number(m[1]);
    }

    function diaOrder(dia){
      const d = String(dia||"").toLowerCase();
      const map = { lunes:1, martes:2, miercoles:3, mi√©rcoles:3, jueves:4, viernes:5, sabado:6, s√°bado:6, domingo:7 };
      return map[d] ?? 99;
    }

    let dt = null;
    let rawRows = [];

    function populateFilters(rows){
      document.querySelector("#filterDia").innerHTML =
        `<option value="">Todos</option>` + uniqueValues(rows,"dia").map(v=>`<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`).join("");
      document.querySelector("#filterFecha").innerHTML =
        `<option value="">Todas</option>` + uniqueValues(rows,"fecha").map(v=>`<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`).join("");
      document.querySelector("#filterHorario").innerHTML =
        `<option value="">Todos</option>` + uniqueValues(rows,"horario").map(v=>`<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`).join("");
      document.querySelector("#filterSede").innerHTML =
        `<option value="">Todas</option>` + uniqueValues(rows,"sede").map(v=>`<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`).join("");
      document.querySelector("#filterArea").innerHTML =
        `<option value="">Todas</option>` + uniqueValues(rows,"area").map(v=>`<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`).join("");
    }

    function renderTable(rows){
      const tbody = document.querySelector("#tabla tbody");
      tbody.innerHTML = "";

      for (const r of rows){
        const dia = pick(r,"dia");
        const fecha = pick(r,"fecha");
        const horario = pick(r,"horario");
        const sede = pick(r,"sede");
        const area = pick(r,"area");

        const cupoRaw = pick(r,"cupo");
        const insRaw  = pick(r,"inscritos");
        const cupo = toNumber(cupoRaw);
        const ins  = toNumber(insRaw);

        const pct = pctFrom(r);
        const pctText = Number.isFinite(pct) ? `${pct.toFixed(0)}%` : "‚Äî";
        const pctBar = Number.isFinite(pct) ? Math.max(0, Math.min(120, pct)) : 0;
        const occ = occClass(pct);

        const tr = document.createElement("tr");
        tr.dataset.dia = String(dia||"").toLowerCase();
        tr.dataset.fecha = String(fecha||"").toLowerCase();
        tr.dataset.horario = String(horario||"").toLowerCase();
        tr.dataset.sede = String(sede||"").toLowerCase();
        tr.dataset.area = String(area||"").toLowerCase();

        tr.innerHTML = `
          <td>${escapeHtml(dia)}</td>
          <td>${escapeHtml(fecha)}<div class="muted small">${escapeHtml(horario)}</div></td>
          <td><span class="badge badge-soft">${escapeHtml(sede)}</span></td>
          <td><span class="badge badge-soft">${escapeHtml(area)}</span></td>
          <td class="text-end">${Number.isFinite(cupo) ? cupo : escapeHtml(cupoRaw)}</td>
          <td class="text-end">${Number.isFinite(ins) ? ins : escapeHtml(insRaw)}</td>
          <td><span class="chip"><span class="dot ${occ.dot}"></span><span>${pctText}</span></span></td>
          <td>
            <div class="d-flex align-items-center gap-2">
              <div class="progress flex-grow-1">
                <div class="progress-bar ${occ.bar}" style="width:${Math.min(100,pctBar)}%"></div>
              </div>
              <span class="small muted" style="min-width:52px;">${occ.label}</span>
            </div>
          </td>
        `;
        tbody.appendChild(tr);
      }

      if (dt) { dt.destroy(); dt = null; }

      // ‚úÖ Clave: NO ordenar en DataTables. Respetar el orden que ya traen las filas.
      dt = new DataTable("#tabla", {
        pageLength: 25,
        lengthMenu: [10,25,50,100],
        ordering: false,
        order: [],
        scrollX: true,
        scrollCollapse: true,
        language: {
          search: "Buscar:",
          lengthMenu: "Mostrar _MENU_",
          info: "Mostrando _START_ a _END_ de _TOTAL_",
          infoEmpty: "Sin datos",
          zeroRecords: "No encontr√© nada con ese filtro",
          paginate: { first:"Primero", last:"√öltimo", next:">", previous:"<" }
        }
      });

      // ‚úÖ Ajuste para que no ‚Äúdesaparezcan‚Äù columnas con wrap
      dt.columns.adjust();

      updateSummaryGlobal(rows);
      wireFilters();
      applyFilters();
      dt.columns.adjust(); // una m√°s despu√©s de aplicar filtros
    }

    function updateSummaryGlobal(rows){
      const total = rows.length;
      let sumCupo=0, sumIns=0;
      for (const r of rows){
        const c = toNumber(pick(r,"cupo"));
        const i = toNumber(pick(r,"inscritos"));
        if (Number.isFinite(c)) sumCupo += c;
        if (Number.isFinite(i)) sumIns += i;
      }
      const pct = (sumCupo>0) ? (sumIns/sumCupo)*100 : NaN;
      document.querySelector("#summary").textContent =
        Number.isFinite(pct)
          ? `${total} filas ¬∑ ${sumIns} inscripciones ¬∑ ${sumCupo} cupos ¬∑ ${pct.toFixed(0)}% ocupaci√≥n`
          : `${total} filas ¬∑ ${sumIns} inscripciones ¬∑ ${sumCupo} cupos`;
    }

    function updateSummaryFiltered(){
      const nodes = dt.rows({ filter:"applied" }).nodes().toArray();
      const total = nodes.length;
      let sumCupo=0, sumIns=0;
      for (const n of nodes){
        const tds = n.querySelectorAll("td");
        const cupo = toNumber(tds[4]?.textContent ?? "");
        const ins  = toNumber(tds[5]?.textContent ?? "");
        if (Number.isFinite(cupo)) sumCupo += cupo;
        if (Number.isFinite(ins)) sumIns += ins;
      }
      const pct = (sumCupo>0) ? (sumIns/sumCupo)*100 : NaN;
      document.querySelector("#summary").textContent =
        Number.isFinite(pct)
          ? `${total} filas (filtradas) ¬∑ ${sumIns} inscripciones ¬∑ ${sumCupo} cupos ¬∑ ${pct.toFixed(0)}% ocupaci√≥n`
          : `${total} filas (filtradas) ¬∑ ${sumIns} inscripciones ¬∑ ${sumCupo} cupos`;
    }

    function applyFilters(){
      if (!dt) return;

      const dia = document.querySelector("#filterDia").value.trim().toLowerCase();
      const fecha = document.querySelector("#filterFecha").value.trim().toLowerCase();
      const horario = document.querySelector("#filterHorario").value.trim().toLowerCase();
      const sede = document.querySelector("#filterSede").value.trim().toLowerCase();
      const area = document.querySelector("#filterArea").value.trim().toLowerCase();

      $.fn.dataTable.ext.search = $.fn.dataTable.ext.search.filter(fn => fn.__ours !== true);

      const filterFn = function(settings, data, dataIndex){
        const row = dt.row(dataIndex).node();
        if (!row) return true;

        if (dia && row.dataset.dia !== dia) return false;
        if (fecha && row.dataset.fecha !== fecha) return false;
        if (horario && row.dataset.horario !== horario) return false;
        if (sede && row.dataset.sede !== sede) return false;
        if (area && row.dataset.area !== area) return false;

        return true;
      };
      filterFn.__ours = true;
      $.fn.dataTable.ext.search.push(filterFn);

      dt.draw();
      dt.columns.adjust();
      updateSummaryFiltered();
    }

    function wireFilters(){
      document.querySelector("#filterDia").onchange = applyFilters;
      document.querySelector("#filterFecha").onchange = applyFilters;
      document.querySelector("#filterHorario").onchange = applyFilters;
      document.querySelector("#filterSede").onchange = applyFilters;
      document.querySelector("#filterArea").onchange = applyFilters;

      document.querySelector("#btnReload").onclick = () => load();
      document.querySelector("#btnOpenCsv").href = csvUrl;

      window.addEventListener("resize", () => {
        if (dt) dt.columns.adjust();
      });
    }

    function load(){
      document.querySelector("#btnOpenCsv").href = csvUrl;

      Papa.parse(csvUrl, {
        download: true,
        header: true,
        skipEmptyLines: true,
        complete: (results) => {
          rawRows = (results.data || []).filter(r => Object.values(r).some(v => String(v ?? "").trim() !== ""));

          // ‚úÖ ORDENAMOS ANTES de mostrar (y luego DataTables no toca el orden)
          rawRows.sort((a,b) => {
            // 1) D√≠a (Lunes..Domingo)
            const d = diaOrder(pick(a,"dia")) - diaOrder(pick(b,"dia"));
            if (d !== 0) return d;

            // 2) Fecha (dd/mm)
            const f = fechaKey(pick(a,"fecha")) - fechaKey(pick(b,"fecha"));
            if (f !== 0) return f;

            // 3) Horario (hora inicio)
            const h = horarioKey(pick(a,"horario")) - horarioKey(pick(b,"horario"));
            if (h !== 0) return h;

            // 4) Sede
            const s = String(pick(a,"sede")||"").localeCompare(String(pick(b,"sede")||""), "es");
            if (s !== 0) return s;

            // 5) Comisi√≥n (√Årea)
            return String(pick(a,"area")||"").localeCompare(String(pick(b,"area")||""), "es");
          });

          populateFilters(rawRows);
          renderTable(rawRows);
        },
        error: (err) => {
          console.error(err);
          alert("No pude leer el CSV. Revis√° que est√© publicado.");
        }
      });
    }

    load();
  </script>
</body>
</html>

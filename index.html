<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Inscripciones</title>

<style>
body{
  font-family: Arial, sans-serif;
  background:#ffffff;
  color:#000000;
  margin:20px;
}

.panel{
  max-width:1400px;
  margin:auto;
}

h1{
  margin-bottom:10px;
}

label{
  font-size:14px;
  display:block;
  margin-bottom:5px;
}

select{
  padding:6px 8px;
  border:1px solid #ccc;
  border-radius:6px;
  margin-bottom:15px;
}

.tablewrap{
  overflow:auto;
  border:1px solid #ccc;
}

table{
  width:100%;
  border-collapse:collapse;
  table-layout:fixed;
}

th,td{
  padding:8px;
  border-bottom:1px solid #ddd;
  font-size:13px;
  vertical-align:top;
}

th{
  background:#f5f5f5;
  text-align:left;
}

td.num{
  text-align:right;
}

.barbg{
  height:8px;
  background:#e5e5e5;
  border-radius:4px;
  overflow:hidden;
}

.bar{
  height:100%;
  background:#4CAF50;
}
</style>
</head>

<body>

<div class="panel">
  <h1>Visualizador de Inscripciones</h1>

  <label>Filtrar por Comisión (Área)</label>
  <select id="fArea">
    <option value="">Todas</option>
  </select>

  <div class="tablewrap">
    <table>
      <thead>
        <tr>
          <th>Día</th>
          <th>Fecha</th>
          <th>Horario</th>
          <th>Sede</th>
          <th>Comisión</th>
          <th class="num">Cupo</th>
          <th class="num">Inscr.</th>
          <th>%</th>
          <th>Ocupación</th>
        </tr>
      </thead>
      <tbody id="tbody">
        <tr><td colspan="9">Cargando...</td></tr>
      </tbody>
    </table>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>

const csvUrl = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ2avA92LvHh37HuCigjLogbT2hhoLprim9OJu7tI9Do2jU6u1hnEsrMov5UKpJHqNcx9fNESB2W3d4/pub?output=csv";

const tbody = document.getElementById("tbody");
const selectArea = document.getElementById("fArea");

let allRows = [];

function toNumber(x){
  const n = Number(String(x).replace(",",".").replace("%",""));
  return Number.isFinite(n) ? n : NaN;
}

function calcularPorcentaje(row){
  const cupo = toNumber(row["Cupo"]);
  const ins  = toNumber(row["# Inscr."]);
  if (cupo > 0 && Number.isFinite(ins)) {
    return Math.round((ins / cupo) * 100);
  }
  return 0;
}

function render(rows){

  if(rows.length === 0){
    tbody.innerHTML = `<tr><td colspan="9">Sin resultados</td></tr>`;
    return;
  }

  tbody.innerHTML = rows.map(r => {

    const porcentaje = calcularPorcentaje(r);

    return `
      <tr>
        <td>${r["Dia"] || ""}</td>
        <td>${r["Fecha"] || ""}</td>
        <td>${r["Horario"] || ""}</td>
        <td>${r["Sede"] || ""}</td>
        <td>${r["Área"] || r["Area"] || ""}</td>
        <td class="num">${r["Cupo"] || ""}</td>
        <td class="num">${r["# Inscr."] || ""}</td>
        <td>${porcentaje}%</td>
        <td>
          <div class="barbg">
            <div class="bar" style="width:${porcentaje}%"></div>
          </div>
        </td>
      </tr>
    `;
  }).join("");
}

function cargarFiltro(){

  const areasUnicas = [...new Set(
    allRows.map(r => r["Área"] || r["Area"] || "")
  )].filter(a => a !== "").sort();

  selectArea.innerHTML = `<option value="">Todas</option>` +
    areasUnicas.map(a => `<option value="${a}">${a}</option>`).join("");
}

selectArea.addEventListener("change", () => {

  const valor = selectArea.value;

  if(valor === ""){
    render(allRows);
  } else {
    const filtradas = allRows.filter(r =>
      (r["Área"] || r["Area"] || "") === valor
    );
    render(filtradas);
  }

});

function cargarDatos(){
  Papa.parse(csvUrl, {
    download:true,
    header:true,
    skipEmptyLines:true,
    complete:(resultado)=>{
      allRows = resultado.data;

      // orden simple
      allRows.sort((a,b)=>{
        return (a["Dia"]||"").localeCompare(b["Dia"]||"")
          || (a["Horario"]||"").localeCompare(b["Horario"]||"")
          || (a["Sede"]||"").localeCompare(b["Sede"]||"");
      });

      cargarFiltro();
      render(allRows);
    }
  });
}

cargarDatos();

</script>

</body>
</html>
